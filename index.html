<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Philippines ESOs Ecosystem Mapping</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- SheetJS for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Icons -->
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    :root { --villgro: #08842a; }
    .brand { color: var(--villgro); }
    .brand-bg { background-color: var(--villgro); }
    .brand-border { border-color: var(--villgro); }
    .pill { border: 1px solid rgba(8,132,42,0.2); border-radius: 9999px; padding: 0.25rem 0.5rem; }
    .pill.active { background: rgba(8,132,42,0.08); border-color: var(--villgro); }
    #map { height: 60vh; min-height: 460px; position: relative; z-index: 0; }
    .leaflet-popup-content { max-width: 260px; }
    .shadow-soft { box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
    .card { border-radius: 1rem; }
    .link { color: #0b7ef4; }
    :focus-visible { outline: 2px dashed var(--villgro); outline-offset: 2px; }
    header.sticky { z-index: 1000 !important; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-5 flex flex-col gap-2">
      <h1 class="text-2xl md:text-3xl font-semibold flex items-center gap-3">
        <span class="inline-block brand-bg text-white rounded-xl px-3 py-1 text-base">Dashboard</span>
        <span>Philippines ESOs Ecosystem Mapping</span>
      </h1>
      <p class="text-sm md:text-base text-gray-600 leading-snug">
        This dashboard maps key ESOs in the Philippines and Southeast Asia, covering type, sector, stage, gender lens, and programs. It supports Villgro’s work in tracking ecosystem partners for women-led and impact-driven enterprises.
      </p>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-1 lg:grid-cols-4 gap-6">

    <!-- Sidebar -->
    <aside class="lg:col-span-1 space-y-4">
      <!-- Legend (top) -->
      <section class="bg-white card shadow-soft p-4">
        <h2 class="font-semibold mb-2">Legend</h2>
        <ul class="text-sm text-gray-600 space-y-1">
          <li><span class="inline-block w-3 h-3 rounded-sm mr-2" style="background: rgba(8,132,42,.2); border: 2px solid var(--villgro);"></span> Coverage radius (from PSGC)</li>
          <li><span class="inline-block w-3 h-3 rounded-full mr-2 brand-bg"></span> ESO HQ pin</li>
        </ul>
      </section>

      <!-- Search & Filters -->
      <section class="bg-white card shadow-soft p-4">
        <h2 class="font-semibold mb-3">Search & Filters</h2>
        <div class="mb-3">
          <label class="text-sm text-gray-600">Search</label>
          <input id="searchInput" type="text" placeholder="Search by ESO, sector, program…" class="mt-1 w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-200 focus:border-green-400" />
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-gray-600">Type</label>
            <select id="filterType" class="mt-1 w-full border rounded-lg px-2 py-2" multiple></select>
          </div>
          <div>
            <label class="text-sm text-gray-600">Stage</label>
            <select id="filterStage" class="mt-1 w-full border rounded-lg px-2 py-2" multiple></select>
          </div>
          <div class="col-span-2">
            <label class="text-sm text-gray-600">Sector</label>
            <select id="filterSector" class="mt-1 w-full border rounded-lg px-2 py-2" multiple></select>
          </div>
          <div>
            <label class="text-sm text-gray-600">Area Type</label>
            <select id="filterAreaType" class="mt-1 w-full border rounded-lg px-2 py-2" multiple>
              <option value="country">Philippines</option>
              <option value="region">Region</option>
              <option value="province">Province</option>
              <option value="city_muni">City/Municipality</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-gray-600">Gender Lens</label>
            <select id="filterGender" class="mt-1 w-full border rounded-lg px-2 py-2">
              <option value="">Any</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="btnApply" class="px-3 py-2 rounded-lg brand-bg text-white text-sm">Apply</button>
          <button id="btnReset" class="px-3 py-2 rounded-lg border text-sm hover:bg-gray-50">Reset</button>
        </div>
      </section>

      <!-- Data status -->
      <section class="bg-white card shadow-soft p-4">
        <h2 class="font-semibold mb-1">Data</h2>
        <div id="dataUpdated" class="text-sm text-gray-700">Date updated: —</div>
        <div id="preloadStatus" class="text-xs text-gray-500 mt-1">Loading…</div>
      </section>
    </aside>

    <!-- Map + List -->
    <section class="lg:col-span-3 space-y-4">
      <div id="map" class="bg-white card shadow-soft"></div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- ESO List -->
        <div class="lg:col-span-1 bg-white card shadow-soft p-4 flex flex-col">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">Entrepreneur Support Orgs</h2>
            <span id="countBadge" class="text-xs px-2 py-1 rounded-full brand-bg text-white">0</span>
          </div>
          <div id="esoList" class="overflow-auto" style="max-height: 60vh;"></div>
        </div>

        <!-- ESO Details -->
        <div class="lg:col-span-2 bg-white card shadow-soft p-4">
          <h2 class="font-semibold mb-3">Details</h2>
          <div id="details" class="text-sm text-gray-700">
            <p class="text-gray-500">Select an ESO from the list or click a marker on the map to see details here.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8 text-xs text-gray-500">
    <div>Basemap © <a class="underline" href="https://www.openstreetmap.org/" target="_blank" rel="noreferrer">OpenStreetMap</a> contributors. Built with Leaflet & SheetJS.</div>
  </footer>

  <script>
    // =====================
    // Global State
    // =====================
    const villgroColor = '#08842a';
    let map, highlightLayerGroup, markersGroup;
    let detailsSheet = [];   // Sheet 1 rows (details)
    let mapSheet = [];       // Sheet 2 rows (map-ready)
    let merged = [];         // Details + map merged by ESO
    let currentFilters = { text: '', types: [], sectors: [], stages: [], areaTypes: [], gender: '' };

    function labelAreaType(t){
      const m = { country: 'Philippines', region: 'Region', province: 'Province', city_muni: 'City/Municipality' };
      return m[(t||'').toLowerCase()] || t;
    }

    const PH_CENTER = [12.8797, 121.7740];
    const PH_BOUNDS = [[4.5,116.5],[21.2,127.0]]; // rectangle fallback

    // =====================
    // Map Initialization
    // =====================
    function initMap() {
      map = L.map('map', { worldCopyJump: true }).setView(PH_CENTER, 5.6);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      highlightLayerGroup = L.layerGroup().addTo(map);
      markersGroup = L.layerGroup().addTo(map);
    }

    // =====================
    // PSGC centroids (coverage centers)
    // =====================
    // Regions (ADM1) PSGC -> [lat, lon]
    const REGION_CENTROIDS = {
      '0100000000':[16.0,120.5],   // Ilocos Region (I)
      '0200000000':[17.2,121.7],   // Cagayan Valley (II)
      '0300000000':[15.0,120.9],   // Central Luzon (III)
      '0400000000':[14.1,121.2],   // CALABARZON (IV-A)
      '0500000000':[13.4,123.5],   // Bicol (V)
      '0600000000':[10.7,122.5],   // Western Visayas (VI)
      '0700000000':[9.7,123.9],    // Central Visayas (VII)
      '0800000000':[11.2,124.9],   // Eastern Visayas (VIII)
      '0900000000':[7.3,122.1],    // Zamboanga Peninsula (IX)
      '1000000000':[8.3,124.7],    // Northern Mindanao (X)
      '1100000000':[7.1,125.6],    // Davao Region (XI)
      '1200000000':[6.9,124.7],    // SOCCSKSARGEN (XII)
      '1300000000':[14.6,121.0],   // NCR
      '1400000000':[17.0,121.0],   // CAR
      '1500000000':[7.2,124.3],    // BARMM
      '1600000000':[8.6,125.9],    // Caraga (XIII)
      '1700000000':[12.5,121.0]    // MIMAROPA (IV-B)
    };
    // Keep old BARMM code variant some sheets use
    REGION_CENTROIDS['1900000000'] = REGION_CENTROIDS['1500000000'];

    // Provinces (ADM2) — add more as needed
    const PROVINCE_CENTROIDS = {
      '041000000':[13.99,121.17],  // Batangas
      '042100000':[14.28,120.89],  // Cavite
      '043400000':[14.18,121.29],  // Laguna
      '051700000':[13.14,123.53],  // Albay
      '051700000':[13.14,123.53],  // Albay (dup safe)
      '133000000':[14.60,121.00]   // Manila (as prov-equivalent)
    };

    // Cities / Municipalities (ADM3) — common ones used in your sheet
    const CITY_CENTROIDS = {
      '137404000':[14.6760,121.0437], // Quezon City
      '137602000':[14.5547,121.0244], // Makati
      '137403000':[14.5760,121.0850], // Pasig
      '137401000':[14.5794,121.0359], // Mandaluyong
      '133900000':[14.5995,120.9842], // Manila
      '137607000':[14.5176,121.0509], // Taguig
      '072217000':[10.3157,123.8854], // Cebu City
      '043403000':[14.3430,121.0810], // Biñan
      '041031000':[14.0836,121.1497], // Tanauan
      '103504000':[8.2280,124.2450],  // Iligan
      '160202000':[8.9475,125.5406],  // Butuan
      '051724000':[13.6217,123.1948], // Naga (Cam. Sur)
      '050170000':[13.1372,123.7344]  // Legazpi
    };

    // =====================
    // Helpers
    // =====================
    const toKey = s => (s||'').toString().trim().toLowerCase();
    const isNum = v => !(v===null || v===undefined || v==='') && !isNaN(parseFloat(v));

    // "a; b ; c" -> ["a","b","c"]
    function multiList(val){
      return String(val||'')
        .split(/[;,\n]/)
        .map(s=>s.trim())
        .filter(Boolean);
    }

    function arrayify(val) {
      if (!val) return [];
      if (Array.isArray(val)) return val;
      return String(val).split(/[,;/\n]/).map(s => s.trim()).filter(Boolean);
    }

    function uniq(arr) { return [...new Set(arr.filter(Boolean))]; }

    function buildOptions(selectEl, values) {
      selectEl.innerHTML = '';
      uniq(values).sort((a,b)=>a.localeCompare(b)).forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v; selectEl.appendChild(opt);
      });
    }

    function applyFilters() {
      const text = currentFilters.text.toLowerCase();
      const tset = new Set(currentFilters.types);
      const sset = new Set(currentFilters.sectors);
      const stset = new Set(currentFilters.stages);
      const atset = new Set(currentFilters.areaTypes);
      const gender = (currentFilters.gender||'').toLowerCase();

      return merged.filter(row => {
        const hay = [row.ESO, row.Type, row.Sectors, row.Programs, row.Stage].map(x => (x||'').toLowerCase()).join(' | ');
        if (text && !hay.includes(text)) return false;
        if (tset.size && !arrayify(row.Type).some(v => tset.has(v))) return false;
        if (sset.size && !arrayify(row.Sectors).some(v => sset.has(v))) return false;
        if (stset.size && !arrayify(row.Stage).some(v => stset.has(v))) return false;
        if (atset.size && !atset.has((row.AreaType||'').toLowerCase())) return false;
        if (gender && (String(row['Gender Lens']||'').toLowerCase() !== gender.toLowerCase())) return false;
        return true;
      });
    }

    // =====================
    // Rendering: List & Details
    // =====================
    function renderList(rows) {
      const list = document.getElementById('esoList');
      list.innerHTML = '';
      document.getElementById('countBadge').textContent = rows.length;
      rows.sort((a,b)=>a.ESO.localeCompare(b.ESO)).forEach(row => {
        const btn = document.createElement('button');
        btn.className = 'w-full text-left px-3 py-2 rounded-lg hover:bg-green-50 focus:bg-green-50 border border-transparent hover:border-green-100 mb-1';
        btn.innerHTML = `<div class="font-medium">${row.ESO||'—'}</div>
                         <div class="text-xs text-gray-500 truncate">${row.Type||''} • ${row.Sectors||''}</div>`;
        btn.addEventListener('click', ()=> selectESO(row.ESO));
        list.appendChild(btn);
      });
    }

    function renderDetails(row) {
      const wrap = document.getElementById('details');
      if (!row) { wrap.innerHTML = '<p class="text-gray-500">Select an ESO from the list or click a marker on the map to see details here.</p>'; return; }

      const fieldsPreferred = [
        ['About','About'],
        ['Flagship Program/s','Flagship Programs'],
        ['Provides Funding','Provides Funding'],
        ['Funding Type','Funding Type'],
        ['Portfolio Enterprises','Portfolio Enterprises'],
        ['Programs','Programs'],
        ['Type','Type'],
        ['Sectors','Sectors'],
        ['Stage','Stage'],
        ['Gender Lens','Gender Lens'],
        ['Email','Email'],
        ['Contact','Contact'],
        ['Notes','Notes']
      ];

      const site = (row.Website || row.SourceURL || '').trim();
      const siteBtn = site
        ? `<a class="pill active text-sm link" target="_blank" rel="noreferrer" href="${site}">Visit site</a>`
        : '';

      let html = `<div class="flex items-start justify-between gap-2">
        <div>
          <h3 class="text-xl font-semibold">${row.ESO||''}</h3>
          <div class="text-xs text-gray-500">Area: <span class="font-medium">${labelAreaType(row.AreaType)||''}</span> — ${row.AreaNames||''}</div>
        </div>
        ${siteBtn}
      </div>`;

      html += '<div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">';
      fieldsPreferred.forEach(([label,key])=> {
        const val = row[key];
        if (!val) return;
        html += `<div class="bg-gray-50 rounded-lg p-3"><div class="text-xs text-gray-500">${label}</div><div class="text-sm">${val}</div></div>`;
      });
      html += '</div>';

      // Show any remaining attributes, excluding keys we never want to show
      const shown = new Set(fieldsPreferred.map(f=>f[1]).concat(['ESO','Website','AreaType','AreaNames','PSGC_Codes','Pin_Lat','Pin_Lon','SourceURL']));
      const OMIT_EXTRA_KEYS = new Set(['Website']);
      const extras = Object.keys(row).filter(k=>row[k] && !shown.has(k) && !OMIT_EXTRA_KEYS.has(k));
      if (extras.length) {
        html += '<div class="mt-4">';
        html += '<h4 class="font-semibold mb-2">More</h4>';
        html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">';
        extras.forEach(k=>{
          html += `<div class="bg-gray-50 rounded-lg p-3"><div class="text-xs text-gray-500">${k}</div><div class="text-sm">${row[k]}</div></div>`;
        });
        html += '</div></div>';
      }

      wrap.innerHTML = html;
    }

    // =====================
    // Map: helpers & drawing
    // =====================
    function clearMap() {
      highlightLayerGroup.clearLayers();
      markersGroup.clearLayers();
    }

    async function shadePhilippines(){
      // Try multiple sources; fall back to a rectangle if offline
      const SOURCES = [
        'https://cdn.jsdelivr.net/gh/wmgeolab/geoBoundaries@main/releaseData/geoBoundariesCGAZ_ADM0/PHL/geoBoundariesCGAZ_ADM0.geojson',
        'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/gh-pages/releaseData/geoBoundariesCGAZ_ADM0/PHL/geoBoundariesCGAZ_ADM0.geojson'
      ];
      if (!window.__PH_GEOJSON__) {
        for (const url of SOURCES) {
          try { const r = await fetch(url, { mode: 'cors' }); if (r.ok) { window.__PH_GEOJSON__ = await r.json(); break; } } catch(e) {}
        }
      }
      if (window.__PH_GEOJSON__) {
        const layer = L.geoJSON(window.__PH_GEOJSON__, { style: { color: villgroColor, weight: 2, fillOpacity: 0.15 } }).addTo(highlightLayerGroup);
        map.fitBounds(layer.getBounds(), { padding: [20,20] });
        return layer;
      } else {
        const rect = L.rectangle(PH_BOUNDS, { color: villgroColor, weight: 2, fillOpacity: 0.15 }).addTo(highlightLayerGroup);
        map.fitBounds(rect.getBounds(), { padding: [20,20] });
        return rect;
      }
    }

    function pin(lat, lon, label, eso, zoomOnClick=true) {
      if (!isNum(lat) || !isNum(lon)) return null;
      const m = L.circleMarker([+lat, +lon], {
        radius: 7,
        weight: 2,
        color: villgroColor,
        fillColor: villgroColor,
        fillOpacity: 0.8
      })
      .addTo(markersGroup)
      .bindPopup(`<div class='text-sm'><div class='font-semibold mb-1'>${eso||label||'ESO'}</div><div>${label||''}</div></div>`);
      m.on('click', ()=>{
        if (zoomOnClick) map.setView(m.getLatLng(), 12, { animate: true });
        selectESO(eso);
      });
      return m;
    }

    // Radius (km) by area type (or by PSGC length)
    function radiusKmFor(areaType, code=''){
      const t = (areaType||'').toLowerCase();
      if (t==='region') return 120;
      if (t==='province') return 45;
      if (t==='city_muni') return 12;
      // Infer by PSGC length if areaType is blank
      const Lc = (code||'').trim().length;
      if (Lc>=10) return 120;     // region-ish
      if (Lc>=9)  return 12;      // city/muni
      if (Lc>=6)  return 45;      // province
      return 20;
    }

    // Lookup a centroid for a PSGC code, falling back to null if unknown
    function centroidForPSGC(code){
      if (!code) return null;
      const c = String(code).trim().toUpperCase();
      if (c==='PH') return PH_CENTER;
      if (REGION_CENTROIDS[c])   return REGION_CENTROIDS[c];
      if (PROVINCE_CENTROIDS[c]) return PROVINCE_CENTROIDS[c];
      if (CITY_CENTROIDS[c])     return CITY_CENTROIDS[c];
      return null;
    }

    // Draw a soft circle coverage; returns the Leaflet circle layer
    function drawCoverage(lat, lon, km){
      if (!isNum(lat) || !isNum(lon)) return null;
      return L.circle([+lat, +lon], {
        radius: km * 1000,
        weight: 2,
        color: villgroColor,
        fillColor: villgroColor,
        fillOpacity: 0.12
      }).addTo(highlightLayerGroup);
    }

    // Coverage polygons from PH, radii from PSGC codes. HQ pins from Pin_Lat/Lon (multi supported)
    async function selectESO(esoName) {
      const row = merged.find(r => toKey(r.ESO) === toKey(esoName));
      if (!row) return;

      renderDetails(row);
      clearMap();

      const areaType = (row.AreaType||'').toLowerCase();
      const codes = multiList(row.PSGC_Codes);
      const latList = multiList(row.Pin_Lat).map(parseFloat);
      const lonList = multiList(row.Pin_Lon).map(parseFloat);

      const bounds = [];

      // 1) Country polygon if any PSGC token is PH or AreaType=country
      if (areaType==='country' || codes.some(c => String(c).trim().toUpperCase()==='PH')) {
        const ph = await shadePhilippines();
        if (ph && ph.getBounds) bounds.push(ph.getBounds());
      }

      // 2) Coverage by PSGC (multiple radii)
      codes.forEach((code, idx) => {
        const c = String(code||'').trim().toUpperCase();
        if (c==='PH') return; // already shaded
        const center = centroidForPSGC(c) || (isNum(latList[idx]) && isNum(lonList[idx]) ? [latList[idx], lonList[idx]] : null);
        if (center){
          const km = radiusKmFor(areaType, c);
          const circ = drawCoverage(center[0], center[1], km);
          if (circ) bounds.push(circ.getBounds());
        }
      });

      // 3) HQ pins (multiple)
      for (let i=0;i<Math.max(latList.length, lonList.length);i++){
        if (isNum(latList[i]) && isNum(lonList[i])){
          const mk = pin(latList[i], lonList[i], row.AreaNames || 'HQ', row.ESO, true);
          if (mk) bounds.push(L.latLngBounds([mk.getLatLng(), mk.getLatLng()]));
        }
      }

      // 4) Fit to whatever we drew
      if (bounds.length){
        // merge bounds
        let bb = bounds[0];
        for (let i=1;i<bounds.length;i++) bb = bb.extend(bounds[i]);
        map.fitBounds(bb.pad(0.2));
      }
    }

    // =====================
    // Data Loading & Merging
    // =====================
    function normalizeColumns(obj) {
      const out = {};
      for (const k in obj) {
        if (!Object.hasOwn(obj, k)) continue;
        const nk = k.replace(/\s+/g,' ').trim();
        out[nk] = obj[k];
      }
      return out;
    }

    function mergeRows(details, mapping) {
      const byName = new Map();
      details.forEach(r => {
        const name = String(r.ESO||r['ESO Name']||r['Name']||'').trim();
        if (!name) return;
        byName.set(name.toLowerCase(), { ...r, ESO: name });
      });

      const output = [];
      mapping.forEach(m => {
        const name = String(m.ESO||'').trim();
        if (!name) return;
        const base = byName.get(name.toLowerCase()) || { ESO: name };
        output.push({ ...base, ...m });
      });

      return output;
    }

    function populateFilters(rows) {
      const types = uniq(rows.flatMap(r => arrayify(r.Type)));
      const sectors = uniq(rows.flatMap(r => arrayify(r.Sectors)));
      const stages = uniq(rows.flatMap(r => arrayify(r.Stage)));
      const build = id => buildOptions(document.getElementById(id), id==='filterSector'?sectors:id==='filterType'?types:stages);
      build('filterType'); build('filterSector'); build('filterStage');
    }

    // =====================
    // Data sources: Built-in JSON + Google Sheets (CSV) via data_sources.json
    // =====================
    async function tryPreloadBuiltins(){
      try {
        const [d,a] = await Promise.all([
          fetch('esos_details.json', { cache: 'no-store' }),
          fetch('esos_area.json', { cache: 'no-store' })
        ]);
        if (!d.ok || !a.ok) throw new Error('Built-in JSON not found');
        detailsSheet = await d.json();
        mapSheet = await a.json();
        merged = mergeRows(detailsSheet, mapSheet);
        populateFilters(merged);
        renderList(merged);
        document.getElementById('btnApply').click();
        setStatus('Loaded data.');
        setUpdated(new Date());
      } catch(err) {
        setStatus('Tip: Add esos_details.json & esos_area.json or configure data_sources.json.');
      }
    }

    function setStatus(msg){
      const s = document.getElementById('preloadStatus');
      if (s) s.textContent = msg;
    }
    function setUpdated(d){
      const el = document.getElementById('dataUpdated');
      if (!el) return;
      try {
        el.textContent = 'Date updated: ' + (new Date(d)).toLocaleString('en-PH', { timeZone: 'Asia/Manila' });
      } catch(_) {
        el.textContent = 'Date updated: —';
      }
    }

    async function tryLoadGoogleSheets(detailsCSV, areaCSV){
      // cache-bust
      const b1 = (detailsCSV.includes('?') ? '&' : '?') + '_ts=' + Date.now();
      const b2 = (areaCSV.includes('?') ? '&' : '?') + '_ts=' + Date.now();
      const [d,a] = await Promise.all([ fetch(detailsCSV + b1), fetch(areaCSV + b2) ]);
      if(!d.ok || !a.ok) throw new Error('CSV not reachable');

      // Last-Modified headers (may be absent due to CORS)
      const lm1 = d.headers.get('last-modified');
      const lm2 = a.headers.get('last-modified');
      const updated = (lm1 || lm2) ? new Date(Math.max(lm1?Date.parse(lm1):0, lm2?Date.parse(lm2):0)) : new Date();
      setUpdated(updated);

      const dtext = await d.text();
      const atext = await a.text();
      const dwb = XLSX.read(dtext, { type:'string' });
      const awb = XLSX.read(atext, { type:'string' });
      const s1 = XLSX.utils.sheet_to_json(dwb.Sheets[dwb.SheetNames[0]], { defval:'' }).map(normalizeColumns);
      const s2 = XLSX.utils.sheet_to_json(awb.Sheets[awb.SheetNames[0]], { defval:'' }).map(normalizeColumns);

      detailsSheet = s1.map(r => ({
        ESO: r.ESO || r['ESO Name'] || r['Name'] || r['Organization'] || '',
        Type: r.Type || r['ESO Type'] || r['Type(s)'] || r['Type of ESO'] || '',
        Sectors: r.Sectors || r['Sector'] || r['Sector/Focus'] || r['Sectors Covered'] || r['Focus Sectors'] || r['Focus Sector(s)'] || r['Industries'] || r['Industry'] || r['Verticals'] || r['Sector(s)'] || '',
        Stage: r.Stage || r['Stages'] || r['Stage Focus'] || '',
        'Gender Lens': r['Gender Lens'] || r['Gender-Lens'] || r['Gender-lens'] || r['Gender'] || '',
        Programs: r.Programs || r['Program(s)'] || r['Programs Offered'] || r['Programs and Initiatives'] || '',
        About: r.About || r['About / Description'] || r['Description'] || '',
        Website: r.Website || r['Website / Link'] || r['Link'] || '',
        Email: r.Email || r['Contact Email'] || '',
        Contact: r.Contact || r['Contact Person'] || '',
        'Flagship Programs': r['Flagship Program/s'] || r['Flagship Programs'] || r['Flagship Program'] || r['Flagship'] || '',
        'Provides Funding': r['Provides Funding'] || r['Provide Funding'] || r['Funding Provided'] || r['Funding?'] || r['Funding (Yes/No)'] || r['Funding'] || '',
        'Funding Type': r['Funding Type'] || r['Type of Funding'] || r['Funding Types'] || '',
        'Portfolio Enterprises': r['Portfolio Enterprises'] || r['Portfolio'] || r['Portfolio Companies'] || ''
      }));

      mapSheet = s2.map(r => ({
        ESO: r.ESO || r['ESO Name'] || r['Name'] || '',
        AreaType: (r.AreaType || r['Area Type'] || '').toString().toLowerCase(),   // country | region | province | city_muni
        AreaNames: r.AreaNames || r['Area Names'] || r['Area'] || '',
        PSGC_Codes: r.PSGC_Codes || r['PSGC Codes'] || r['PSGC'] || r['Code'] || '',
        Pin_Lat: r.Pin_Lat || r['Lat'] || r['Latitude'] || '',
        Pin_Lon: r.Pin_Lon || r['Lon'] || r['Longitude'] || '',
        Notes: r.Notes || r['Notes / Remarks'] || '',
        SourceURL: r.SourceURL || r['Source URL'] || r['URL'] || r['Link'] || ''
      }));

      merged = mergeRows(detailsSheet, mapSheet);
      populateFilters(merged);
      renderList(merged);
      document.getElementById('btnApply').click();
      setStatus('Loaded data.');
    }

    async function tryLoadFromConfig(){
      try {
        const r = await fetch('data_sources.json', { cache: 'no-store' });
        if (!r.ok) { setStatus('No data_sources.json found; trying built-in data…'); return tryPreloadBuiltins(); }
        const cfg = await r.json();
        if (cfg.mode === 'gsheets' && cfg.gsheets?.detailsCSV && cfg.gsheets?.areaCSV) {
          return tryLoadGoogleSheets(cfg.gsheets.detailsCSV, cfg.gsheets.areaCSV);
        }
        // fallback to built-in JSON next to index.html
        return tryPreloadBuiltins();
      } catch(e) {
        setStatus('Could not load config; falling back to built-in data.');
        return tryPreloadBuiltins();
      }
    }

    // =====================
    // Wiring UI
    // =====================
    document.getElementById('btnApply').addEventListener('click', async ()=>{
      const sel = el => Array.from(el.selectedOptions).map(o => o.value);
      currentFilters.text   = document.getElementById('searchInput').value || '';
      currentFilters.types  = sel(document.getElementById('filterType'));
      currentFilters.sectors= sel(document.getElementById('filterSector'));
      currentFilters.stages = sel(document.getElementById('filterStage'));
      currentFilters.areaTypes = sel(document.getElementById('filterAreaType'));
      currentFilters.gender = document.getElementById('filterGender').value || '';

      const rows = applyFilters();
      renderList(rows);

      // Overview: show pins only (fast). Coverage radii appear when an ESO is selected.
      clearMap();
      for (const r of rows) {
        const latList = multiList(r.Pin_Lat).map(parseFloat);
        const lonList = multiList(r.Pin_Lon).map(parseFloat);
        for (let i=0;i<Math.max(latList.length, lonList.length);i++){
          if (isNum(latList[i]) && isNum(lonList[i])) pin(latList[i], lonList[i], r.AreaNames, r.ESO, false);
        }
      }
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      currentFilters = { text: '', types: [], sectors: [], stages: [], areaTypes: [], gender: '' };
      document.getElementById('searchInput').value = '';
      ['filterType','filterSector','filterStage','filterAreaType'].forEach(id=>{
        const el = document.getElementById(id); Array.from(el.options).forEach(o=>o.selected=false);
      });
      document.getElementById('filterGender').value='';
      renderList(merged);
      clearMap();
    });

    // Kick things off
    initMap();
    tryLoadFromConfig(); // reads data_sources.json and loads Google Sheets or built-in JSON
    feather.replace();
  </script>
</body>
</html>
